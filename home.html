<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Chat Firebase</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: white;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .msg {
    background: #2a2a2a;
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .msg.me {
    background: #4CAF50;
    align-self: flex-end;
  }
  #inputBar {
    display: flex;
    padding: 10px;
    background: #1e1e1e;
    border-top: 1px solid #333;
  }
  #messageInput {
    flex: 1;
    background: #2c2c2c;
    border: none;
    padding: 12px;
    border-radius: 20px;
    color: white;
    outline: none;
    font-size: 14px;
  }
  #sendBtn {
    background: none;
    border: none;
    margin-left: 8px;
    cursor: pointer;
  }
  #sendBtn img {
    width: 28px;
    height: 28px;
  }
  /* Popup pseudo */
  #pseudoPopup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #popupContent {
    background: #2c2c2c;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    width: 300px;
  }
  #popupContent h2 {
    margin-bottom: 15px;
  }
  #pseudoInput {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    margin-bottom: 10px;
    outline: none;
    font-size: 14px;
    background: #1e1e1e;
    color: white;
  }
  #savePseudoBtn {
    background: #4CAF50;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    font-size: 14px;
  }
</style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
</head>
<body>

<div id="messages"></div>

<div id="inputBar">
  <input type="text" id="messageInput" placeholder="Ã‰crire un message...">
  <button id="sendBtn"><img src="send.png" alt="Envoyer"></button>
</div>

<!-- Popup pour le pseudo -->
<div id="pseudoPopup">
  <div id="popupContent">
    <h2>Choisis ton pseudo</h2>
    <input type="text" id="pseudoInput" placeholder="Ton pseudo">
    <br>
    <button id="savePseudoBtn">Valider</button>
  </div>
</div>

<!-- Firebase -->


<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD8rGFTJaR7IL-H8HuyzyLQc8UgGUo2gwY",
    authDomain: "everfrost-9252f.firebaseapp.com",
    databaseURL: "https://everfrost-9252f-default-rtdb.firebaseio.com/",
    projectId: "everfrost-9252f",
    storageBucket: "everfrost-9252f.firebasestorage.app",
    messagingSenderId: "533335101790",
    appId: "1:533335101790:web:544b717c3f18e847babfcf",
    measurementId: "G-BT1S62HC6N"
  };

  // Init Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUID = null;
  let currentPseudo = null;

  // Auth anonyme
  auth.signInAnonymously().then(() => {
    currentUID = auth.currentUser.uid;
    checkPseudo();
  });

  // VÃ©rifie si le pseudo existe
  function checkPseudo() {
    db.ref("users/" + currentUID + "/pseudo").once("value", snapshot => {
      if (snapshot.exists()) {
        currentPseudo = snapshot.val();
        document.getElementById("pseudoPopup").style.display = "none";
        listenMessages();
      } else {
        document.getElementById("pseudoPopup").style.display = "flex";
      }
    });
  }

  // Sauvegarde du pseudo
  document.getElementById("savePseudoBtn").addEventListener("click", () => {
    const pseudo = document.getElementById("pseudoInput").value.trim();
    if (pseudo) {
      db.ref("users/" + currentUID).set({ pseudo: pseudo });
      currentPseudo = pseudo;
      document.getElementById("pseudoPopup").style.display = "none";
      listenMessages();
    }
  });

  // Ã‰coute des messages
  function listenMessages() {
    const messagesDiv = document.getElementById("messages");
    db.ref("messages").on("child_added", snapshot => {
      const data = snapshot.val();
      const div = document.createElement("div");
      div.classList.add("msg");
      if (data.uid === currentUID) div.classList.add("me");
      div.textContent = data.username + ": " + data.text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // Envoi d'un message
  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  document.getElementById("messageInput").addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
  });

  function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (text && currentPseudo) {
      db.ref("messages").push({
        username: currentPseudo,
        text: text,
        uid: currentUID,
        timestamp: Date.now()
      });
      document.getElementById("messageInput").value = "";
    }
  }
</script>

</body>
</html>
