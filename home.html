<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KykyChat - Amis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik&display=swap');
    body {
      margin: 0;
      padding: 0;
      font-family: 'Rubik', sans-serif;
      background-color: #2e2e2e;
      color: white;
    }
    header {
      display: flex;
      justify-content: flex-end;
      padding: 20px;
    }
    #addFriendBtn {
      background-color: #5865F2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    #friendList {
      margin: 20px;
    }
    .friend {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .friend .info {
      display: flex;
      flex-direction: column;
    }
    .friend .info .pseudo {
      font-weight: bold;
      font-size: 1.1em;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2f3136;
      padding: 20px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .popup input {
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 4px;
      width: 100%;
    }
    .popup button {
      margin-top: 10px;
      background-color: #5865F2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <button id="addFriendBtn">+ Ajouter un ami</button>
  </header>

  <div id="friendList"></div>

  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <h3>Ajouter un ami</h3>
    <input type="text" id="friendIdInput" placeholder="Identifiant de l'ami">
    <button onclick="sendFriendRequest()">Demander</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, onValue, update, push, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQGmbiwh5LTVq0Wp1q9NrSQzs86vER2XM",
  authDomain: "kychat-45596.firebaseapp.com",
  databaseURL: "https://kychat-45596-default-rtdb.firebaseio.com",
  projectId: "kychat-45596",
  storageBucket: "kychat-45596.firebasestorage.app",
  messagingSenderId: "104462848972",
  appId: "1:104462848972:web:7ac49e63008e9a11150369"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const userId = localStorage.getItem("userId");

    document.getElementById("addFriendBtn").onclick = () => {
      document.getElementById("popup").style.display = 'block';
      document.getElementById("overlay").style.display = 'block';
    }

    document.getElementById("overlay").onclick = () => {
      document.getElementById("popup").style.display = 'none';
      document.getElementById("overlay").style.display = 'none';
    }

    window.sendFriendRequest = function () {
      const friendId = document.getElementById("friendIdInput").value;
      const requestRef = ref(db, `users/${friendId}/pending/${userId}`);
      set(requestRef, true);
      alert("Demande envoyée à " + friendId);
      document.getElementById("popup").style.display = 'none';
      document.getElementById("overlay").style.display = 'none';
    }

    function loadFriends() {
      const friendRef = ref(db, `users/${userId}/friends`);
      onValue(friendRef, snapshot => {
        const list = document.getElementById("friendList");
        list.innerHTML = "";
        snapshot.forEach(childSnap => {
          const fid = childSnap.key;
          get(ref(db, `users/${fid}`)).then(friendSnap => {
            const data = friendSnap.val();
            if (!data || !data.pseudo || !data.id || !data.state) {
              const newPseudo = prompt("Entrez le pseudo pour " + fid);
              const newState = prompt("Entrez le statut pour " + fid);
              const newId = prompt("Entrez l'identifiant pour " + fid);
              if (newPseudo && newState && newId) {
                set(ref(db, `users/${fid}`), {
                  pseudo: newPseudo,
                  state: newState,
                  id: newId
                });
              }
              return;
            }
            const div = document.createElement("div");
            div.className = "friend";
            div.innerHTML = `
              <div class="info">
                <span class="pseudo">${data.pseudo}</span>
                <span style="color: gray; font-size: 0.9em;">${data.state}</span>
              </div>
              <div style="color: rgba(255,255,255,0.6); font-size: 0.8em;">${data.id}</div>
            `;
            list.appendChild(div);
          });
        });
      });
    }

    loadFriends();
  </script>
</body>
</html>
