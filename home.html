<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whispr - Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script type="module" src="home.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #610055;
      color: white;
      font-family: 'Press Start 2P', cursive;
      overflow: hidden;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #54134c;
      padding: 30px;
      z-index: 10;
      display: none;
      flex-direction: column;
      align-items: center;
      border: 2px solid white;
    }

    .popup.show {
      display: flex;
    }

    .popup h2 {
      color: white;
      margin-bottom: 10px;
      text-align: center;
    }

    .popup input {
      background-color: #4f1f49;
      color: white;
      border: none;
      padding: 10px;
      margin-top: 10px;
      width: 200px;
      text-align: center;
    }

    .popup button {
      background-color: #b4009e;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-top: 10px;
      cursor: pointer;
      align-self: flex-end;
    }

    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #4f1f49;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      box-sizing: border-box;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 40px;
      width: 250px;
      background-color: #4f1f49;
      padding: 20px;
      box-sizing: border-box;
    }

    .main-content {
      margin-left: 270px;
      padding: 20px;
      padding-bottom: 60px;
      overflow-y: auto;
      height: calc(100vh - 60px);
    }

    .friend-section {
      margin-top: 20px;
    }

    .friend-header {
      position: relative;
      margin-bottom: 10px;
    }

    .friend-label {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      padding: 4px 10px;
      display: inline-block;
      position: relative;
      z-index: 2;
      border-radius: 0;
    }

    .friend-label.green {
      background-color: #4caf50;
      color: white;
    }

    .friend-label.gray {
      background-color: #777;
      color: white;
    }

    .friend-line {
      height: 4px;
      width: 100%;
      position: absolute;
      top: 50%;
      left: 0;
      z-index: 1;
    }

    .friend-line.green {
      background-color: #4caf50;
    }

    .friend-line.gray {
      background-color: #777;
    }

    .sidebar button {
      background-color: #b4009e;
      border: none;
      color: white;
      padding: 10px;
      margin-bottom: 20px;
      cursor: pointer;
      width: 100%;
    }

    .popup .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Popup Choix Pseudo -->
  <div id="choosePseudoPopup" class="popup">
    <h2>Choisis ton pseudo!</h2>
    <img src="avatar.png" alt="avatar" width="100" />
    <input type="text" id="pseudoInput" placeholder="Ton pseudo" />
    <button onclick="savePseudo()">Commencer!</button>
  </div>

  <!-- Popup Ajouter Ami -->
  <div id="addFriendPopup" class="popup">
    <button class="close-btn" onclick="closeAddFriendPopup()">X</button>
    <h2>Rentre son pseudo</h2>
    <img src="search.png" alt="search" width="100" />
    <input type="text" id="searchFriendInput" placeholder="Pseudo" />
    <div id="searchResults"></div>
  </div>

  <div class="sidebar">
    <button onclick="openAddFriendPopup()">Ajouter un ami</button>
    <button onclick="openGroupCreator()">Nouveau groupe</button>
  </div>

  <div class="main-content">
    <!-- Tabs: Tous les amis / Demandes / Groupes -->
    <div class="friend-section online">
      <div class="friend-header">
        <div class="friend-label green">En ligne</div>
        <div class="friend-line green"></div>
      </div>
      <div id="friendsOnline"></div>
    </div>

    <div class="friend-section offline">
      <div class="friend-header">
        <div class="friend-label gray">Hors ligne</div>
        <div class="friend-line gray"></div>
      </div>
      <div id="friendsOffline"></div>
    </div>
  </div>

  <div class="bottom-bar">
    <span id="userPseudo">TonPseudo</span>
    <div>
      <button onclick="toggleMicro()">ðŸŽ¤</button>
      <button onclick="toggleSound()">ðŸ”‡</button>
    </div>
  </div>
<script>
  // Initialisation Firebase (remplace les valeurs si besoin)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQGmbiwh5LTVq0Wp1q9NrSQzs86vER2XM",
  authDomain: "kychat-45596.firebaseapp.com",
  databaseURL: "https://kychat-45596-default-rtdb.firebaseio.com",
  projectId: "kychat-45596",
  storageBucket: "kychat-45596.appspot.com",
  messagingSenderId: "104462848972",
  appId: "1:104462848972:web:7ac49e63008e9a11150369"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

// Ã‰tat des utilisateurs connectÃ©s
const userStatusRef = (uid) => ref(db, 'status/' + uid);

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const uid = user.uid;
    const pseudoRef = ref(db, `users/${uid}/pseudo`);
    const snapshot = await get(pseudoRef);

    if (!snapshot.exists()) {
      document.getElementById("choosePseudoPopup").style.display = "flex";
    } else {
      document.getElementById("bottom-bar-pseudo").innerText = snapshot.val();
    }

    // Marquer l'utilisateur en ligne
    update(userStatusRef(uid), { online: true });
    window.addEventListener("beforeunload", () => {
      update(userStatusRef(uid), { online: false });
    });
  } else {
    window.location.href = "index.html";
  }
});

// Choisir le pseudo
const pseudoInput = document.getElementById("pseudoInput");
const startBtn = document.getElementById("startBtn");

startBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user || !pseudoInput.value) return;

  await set(ref(db, `users/${user.uid}`), {
    pseudo: pseudoInput.value,
    muteMic: false,
    muteSound: false
  });

  document.getElementById("choosePseudoPopup").style.display = "none";
  document.getElementById("bottom-bar-pseudo").innerText = pseudoInput.value;
});

// Mute Micro / Son
const toggleMicBtn = document.getElementById("toggleMic");
const toggleSoundBtn = document.getElementById("toggleSound");

const updateMuteStatus = (field, value) => {
  const user = auth.currentUser;
  if (!user) return;
  update(ref(db, `users/${user.uid}`), {
    [field]: value
  });
};

toggleMicBtn.addEventListener("click", () => {
  const user = auth.currentUser;
  if (!user) return;
  const refUser = ref(db, `users/${user.uid}/muteMic`);
  get(refUser).then(snap => {
    const current = snap.val();
    updateMuteStatus("muteMic", !current);
  });
});

toggleSoundBtn.addEventListener("click", () => {
  const user = auth.currentUser;
  if (!user) return;
  const refUser = ref(db, `users/${user.uid}/muteSound`);
  get(refUser).then(snap => {
    const current = snap.val();
    updateMuteStatus("muteSound", !current);
  });
});

</script>
</body>
</html>
