<script>
const firebaseConfig = {
    apiKey: "AIzaSyDQGmbiwh5LTVq0Wp1q9NrSQzs86vER2XM",
    authDomain: "kychat-45596.firebaseapp.com",
    databaseURL: "https://kychat-45596-default-rtdb.firebaseio.com",
    projectId: "kychat-45596",
    storageBucket: "kychat-45596.appspot.com",
    messagingSenderId: "104462848972",
    appId: "1:104462848972:web:7ac49e63008e9a11150369"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser;
const activeChatListeners = new Set();

auth.onAuthStateChanged(async (user) => {
    if (!user) return window.location.href = 'index.html';
    currentUser = user;

    await db.ref(`users/${user.uid}/actual`).set("main");

    // Statut online/offline
    const statusRef = db.ref(`users/${user.uid}/connectivity`);
    statusRef.set('online');
    statusRef.onDisconnect().set('offline');

    const snap = await db.ref(`users/${user.uid}`).once('value');
    const data = snap.val();

    if (!data || !data.pseudo || !data.state || !data.id) {
        showPopup('fillInfoPopup');
    } else {
        loadFriends();
    }

    // Écoute des nouveaux messages dans les chats liés à l'utilisateur
    listenToUserChats(user.uid);
});

function openPopup() {
    showPopup('addFriendPopup');
}

function showPopup(id) {
    document.getElementById('overlay').style.display = 'block';
    document.getElementById(id).style.display = 'flex';
}

function hidePopups() {
    document.getElementById('overlay').style.display = 'none';
    document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
}

document.getElementById('overlay').addEventListener('click', hidePopups);

async function sendFriendRequest() {
    const friendId = document.getElementById('friendIdInput').value.trim();
    if (!friendId) return alert("Veuillez entrer un identifiant.");
    const usersSnap = await db.ref('users').once('value');
    let found = false;

    usersSnap.forEach(child => {
        const data = child.val();
        if (data.id === friendId && child.key !== currentUser.uid) {
            db.ref(`friend_requests/${child.key}/${currentUser.uid}`).set(true);
            alert("Demande envoyée à " + data.pseudo);
            found = true;
        }
    });

    if (!found) alert("Utilisateur introuvable.");
    hidePopups();
}

async function saveUserInfo() {
    const pseudo = document.getElementById('pseudoInput').value.trim();
    const state = document.getElementById('stateInput').value.trim();
    const id = document.getElementById('idInput').value.trim();

    if (!pseudo || !state || !id) return alert("Merci de remplir tous les champs.");

    await db.ref(`users/${currentUser.uid}`).update({ pseudo, state, id });
    hidePopups();
    loadFriends();
}

async function loadFriends() {
    const list = document.getElementById('friendList');
    list.innerHTML = '';

    const requestsSnap = await db.ref(`friend_requests/${currentUser.uid}`).once('value');
    const requests = requestsSnap.val() || {};

    for (const senderUid in requests) {
        const senderSnap = await db.ref(`users/${senderUid}`).once('value');
        const data = senderSnap.val();
        const div = document.createElement('div');
        div.className = 'friend-card';
        div.innerHTML = `
            <div>
                <strong>Demande de ${data?.pseudo || 'Inconnu'}</strong><br>
                <span>${data?.id || ''}</span>
            </div>
            <button onclick="acceptFriend('${senderUid}')">Accepter</button>
        `;
        list.appendChild(div);
    }

    const friendsSnap = await db.ref(`users/${currentUser.uid}/friends`).once('value');
    if (!friendsSnap.exists()) return;

    for (const friendUid of Object.keys(friendsSnap.val())) {
        const snap = await db.ref(`users/${friendUid}`).once('value');
        const data = snap.val();
        if (!data) continue;

        const card = createFriendCard(
            friendUid,
            data.pseudo || "Inconnu",
            data.state || "Statut inconnu",
            data.id || "ID manquant"
        );
        list.appendChild(card);
    }
}

function createFriendCard(uid, name, statusText, userId) {
    const card = document.createElement("div");
    card.className = "friend-card";
    card.id = `friend-${uid}`;
    card.style.cursor = "pointer";
    card.addEventListener("click", async () => {
        await db.ref(`users/${currentUser.uid}/actual`).set(uid);
        window.location.href = "chat.html";
    });

    const info = document.createElement("div");
    info.className = "friend-info";

    const profileWrapper = document.createElement("div");
    profileWrapper.className = "profile-wrapper";

    const profilePic = document.createElement("img");
    profilePic.className = "profile-pic";
    profilePic.src = "";
    profilePic.onerror = () => {
        profilePic.src = "defaultpdp.png";
    };

    firebase.database().ref("users/" + uid + "/pdp").once("value").then(snapshot => {
        const value = snapshot.val();
        if (value && value.startsWith("pdp:")) {
            profilePic.src = value.replace("pdp:", "").trim();
        } else {
            profilePic.src = "defaultpdp.png";
        }
    }).catch(() => {
        profilePic.src = "defaultpdp.png";
    });

    const statusDot = document.createElement("span");
    statusDot.className = "status-dot offline";

    const statusRef = db.ref(`users/${uid}/connectivity`);
    statusRef.on("value", (snapshot) => {
        const value = snapshot.val();
        statusDot.classList.remove("online", "offline");
        if (value === "online") {
            statusDot.classList.add("online");
        } else {
            statusDot.classList.add("offline");
        }
    });

    profileWrapper.appendChild(profilePic);
    profileWrapper.appendChild(statusDot);

    const details = document.createElement("div");
    details.className = "friend-details";

    const nameEl = document.createElement("strong");
    nameEl.textContent = name;

    const statusEl = document.createElement("span");
    statusEl.textContent = statusText;

    details.appendChild(nameEl);
    details.appendChild(statusEl);

    info.appendChild(profileWrapper);
    info.appendChild(details);

    const userIdEl = document.createElement("div");
    userIdEl.className = "friend-id";
    userIdEl.textContent = userId;

    card.appendChild(info);
    card.appendChild(userIdEl);

    return card;
}

async function acceptFriend(friendUid) {
    await db.ref(`users/${currentUser.uid}/friends/${friendUid}`).set(true);
    await db.ref(`users/${friendUid}/friends/${currentUser.uid}`).set(true);
    await db.ref(`friend_requests/${currentUser.uid}/${friendUid}`).remove();
    loadFriends();
}

// Notifications messages privés
function listenToUserChats(uid) {
    db.ref('chats').on('child_added', (chatSnap) => {
        const chatId = chatSnap.key;
        if (!chatId.includes(uid)) return;
        if (activeChatListeners.has(chatId)) return;
        activeChatListeners.add(chatId);

        db.ref(`chats/${chatId}/messages`).limitToLast(1).on('child_added', (msgSnap) => {
            const data = msgSnap.val();
            if (!data || data.from === uid) return;

            const from = data.from || "Inconnu";
            const text = data.text || "(Message vide)";
            const timestamp = new Date(data.timestamp || Date.now()).toLocaleString();
            showNotification(from, text, timestamp);
        });
    });
}

function showNotification(from, text, timestamp) {
    const notif = document.createElement("div");
    notif.style.background = "#2c2f36";
    notif.style.color = "white";
    notif.style.borderRadius = "12px";
    notif.style.boxShadow = "0 4px 12px rgba(0, 0, 0, 0.3)";
    notif.style.padding = "16px";
    notif.style.minWidth = "250px";
    notif.style.maxWidth = "300px";
    notif.style.fontFamily = "Inter, sans-serif";
    notif.style.position = "relative";
    notif.style.overflow = "hidden";

    const bar = document.createElement("div");
    bar.style.height = "6px";
    bar.style.background = "#43b581";
    bar.style.position = "absolute";
    bar.style.top = "0";
    bar.style.left = "0";
    bar.style.width = "100%";
    bar.style.borderTopLeftRadius = "12px";
    bar.style.borderTopRightRadius = "12px";

    notif.appendChild(bar);

    const title = document.createElement("div");
    title.textContent = `Nouveau message de ${from} !`;
    title.style.fontWeight = "700";
    title.style.marginBottom = "8px";
    notif.appendChild(title);

    const body = document.createElement("div");
    body.textContent = text;
    body.style.marginBottom = "6px";
    notif.appendChild(body);

    const time = document.createElement("div");
    time.textContent = timestamp;
    time.style.color = "#aaa";
    time.style.fontSize = "0.85rem";
    notif.appendChild(time);

    document.getElementById("notifContainer").appendChild(notif);

    setTimeout(() => {
        notif.remove();
    }, 6000);
}
</script>
